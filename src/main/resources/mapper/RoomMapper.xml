<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
   "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.example.demo.room.RoomMapper">

	<select id="roomInfo" resultType="com.example.demo.dto.RoomDto">
		SELECT * FROM room WHERE roomid=#{roomid}
		ORDER BY roomid DESC
	</select>
	
	<select id="RoomList" resultType="com.example.demo.dto.RoomDto">
		SELECT * FROM room
		<where>
        <if test="rcode != null and rcode !=''">
            rcode LIKE CONCAT(#{rcode},'%')
        </if>
        <if test="searchKeyword != null and searchKeyword !=''">
            AND (
                name LIKE CONCAT('%', #{searchKeyword}, '%') 
                OR keyword LIKE CONCAT('%', #{searchKeyword}, '%')
            )
        </if>
    AND duration_type = 2
    </where>
    ORDER BY duration_type DESC
	</select>


	<select id="roomContent" resultType="com.example.demo.dto.RoomDto">
		SELECT * FROM room WHERE rcode=#{rcode}
	</select>
	
	<select id="getMember" resultType="com.example.demo.dto.MemberDto">
	    SELECT * FROM member WHERE userid=#{userid}
	</select>

   <select id="getNumber" resultType="Integer">
   	SELECT IFNULL(MAX(RIGHT(jumuncode,3)),0)+1
  	FROM reservation
   	WHERE jumuncode LIKE CONCAT(#{jumuncode},'%')
   </select>
   
	<insert id="reservOk" parameterType="com.example.demo.dto.ReservationDto">
	    INSERT INTO reservation(startTime,endTime,rcode,card1,tel,
	    halbu1,bank1,card2,bank2,jumuncode,writeday,purposeuse,requesttohost,reservprice)
	    VALUES (#{startTime},#{endTime},#{rcode},#{card1},#{tel},#{halbu1},
	    #{bank1},#{card2},#{bank2},#{jumuncode},now(),#{purposeuse},#{requesttohost},#{reservprice})
	</insert>

   
   <select id="reservList" parameterType="com.example.demo.dto.ReservationDto" resultType="com.example.demo.dto.ReservationDto">
		SELECT * FROM reservation WHERE jumuncode=#{jumuncode}
	</select>
   <select id="reservChk" parameterType="com.example.demo.dto.ReservationDto" resultType="com.example.demo.dto.ReservationDto">
		SELECT * FROM reservation WHERE jumuncode=#{jumuncode}
	</select>
	
	  <select id="getReservTime"  resultType="com.example.demo.dto.ReservationDto">
	    select substring(startTime,12,2) as startTime  , substring(endTime,12,2) as endTime 
	    from reservation
	     where rcode=#{rcode} and startTime like concat(#{ymd} , '%')
	</select> 

	<select id="getReservationsByroomid" resultType="com.example.demo.dto.ReservationDto">
	    SELECT * FROM reservation WHERE roomid=#{roomid} ORDER BY writeday DESC
	</select>
	<!-- 좋아요 여부 확인 -->
<select id="isLikedByUser" resultType="boolean">
  <!-- userId가 null이면 false 반환 -->
  <if test="userId == null">
    SELECT false
  </if>
  <if test="userId != null">
    SELECT heart > 0
    FROM room
    WHERE roomid = #{roomid}
  </if>
</select>

<!-- 좋아요 추가 -->
<update id="insertLike">
  UPDATE room
  SET heart = heart + 1
  WHERE roomid = #{roomid}
</update>

<!-- 좋아요 삭제 -->
<update id="deleteLike">
  UPDATE room
  SET heart = GREATEST(heart - 1, 0)
  WHERE roomid = #{roomid}
</update>

<!-- 방 좋아요 수 증가 -->
<update id="increaseRoomLike">
    UPDATE room
    SET heart = heart + 1
    WHERE roomid = #{roomid}
</update>

<!-- 방 좋아요 수 감소 -->
<update id="decreaseRoomLike">
    UPDATE room
    SET heart = GREATEST(heart - 1, 0)
    WHERE roomid = #{roomid}
</update>

<!-- roomid로 rcode 조회 -->
<select id="getRoomLikes" resultType="int">
    SELECT heart
    FROM room
    WHERE roomid = #{roomid}
</select>
<select id="getRcodeByroomid" resultType="String">
    SELECT rcode FROM room WHERE roomid = #{roomid}
</select>
<select id="getReservationsByUserId" resultType="com.example.demo.dto.ReservationDto">
    SELECT r.*, rm.name as room_name
    FROM reservation r 
    LEFT JOIN room rm ON r.rcode = rm.rcode 
    WHERE r.userid = #{userid} 
    ORDER BY r.writeday DESC
</select>
</mapper>


